name: reload database
on: 
  - workflow_dispatch
jobs:
  backup:
    runs-on: MySanpete
    steps:
      - name: backup
        run: |
          mkdir -p /home/enoch/dumps

          CONTAINER_NAME=$(kubectl -n codebras get pods --no-headers -o custom-columns=":metadata.name" | grep my-sanpete-database-deployment)

          kubectl -n codebras cp /home/enoch/dumps/mysanpetedump.sql \
          $CONTAINER_NAME:/mysanpetedump.sql \
          && kubectl -n codebras exec -i $CONTAINER_NAME -- sh -c \
          'pg_restore -U postgres -d postgres --no-owner -1 /mysanpetedump.sql'